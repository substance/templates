<!DOCTYPE html>
<html>
<head>

  <!--
    This document has been generated by the Substance Composer (1.0.0 Beta-4)
    http://substance.io/composer
   -->

  <meta charset="utf-8"/>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=yes" />
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>

  <%
    var citations = _.map(doc.get('citations').nodes, function(citationId) {
      return doc.get(citationId);
    });
  %>


  <script>
    $(function() {
      var tocToggled = false;
      var lastScrollPos;

      function tocActive() {
        return $('body').hasClass('toc-active');
      }

      $('a.toggle-toc').on('click', function() {
        if (tocActive()) {
          $('body').removeClass('toc-active');

          // Restore saved scroll position
          $(window).scrollTop(lastScrollPos);
          console.log('restoring scrollpos ', lastScrollPos);
        } else {
          lastScrollPos = $(window).scrollTop();
          console.log('storing last pos ', lastScrollPos);
          $('body').addClass('toc-active');
        }      
        return false;
      });

      // Jump to node
      // ----------------
      // 

      $('.jumpto-node').on('click', function(e) {
        var nodeId = $(e.currentTarget).attr("data-id");

        $('body').removeClass('toc-active');

        var $n = $('#'+nodeId);
        if ($n.length > 0) {

          var topOffset = $n.position().top;
          var contentHeight = $('.article').height();
          var panelHeight = $(window).height();

          // This is the inverse compuptation as in markActiveHeading
          var regularOffset = topOffset;
          var smartOffset = (topOffset + contentHeight - 2 * panelHeight)*0.5;
          var offset = Math.min(regularOffset, smartOffset);

          $(window).scrollTop(Math.ceil(offset));

          // TODO: Find a way so this does not trigger a hashchange event
          // window.location.hash = nodeId;
        }

        return false;
      });
      
      // Update active section
      // ----------------
      // 

      $(window).on('scroll', function() {
        if (tocToggled) return;
        var scrollTop = $(window).scrollTop();
        // console.log('scrolltop', scrollTop);

        var contentHeight = $('.article').height();
        var panelHeight = $(window).height();
        var scrollBottom = scrollTop + panelHeight;

        var regularScanline = scrollTop;
        var smartScanline = 2 * scrollBottom - contentHeight;
        var scanline = Math.max(regularScanline, smartScanline);

        var headings = $('.content-node.heading');

        // Use first heading as default
        var activeNode = null; // headings[0].id;

        headings.each(function() {
          if (scanline >= $(this).position().top) {
            activeNode = this.id;
          }
        });

        // Update it
        var headingName;

        if (activeNode) {
          headingName = $('#'+activeNode+' .heading-name').text();
        } else {
          headingName = "<%= doc.title %>"
        }
        

        $('.header .section').html(headingName);
      });


    });
  </script>

  <link href="style.css" rel="stylesheet" />
  <% if (options.enable_bookmarks) { %>
  <script src="jquery-2.1.0.min.js"></script>
  <script src="underscore.js"></script>
  <script src="app.js"></script>
  <% } %>

  <title><%= doc.title %></title>
</head>
<body class="<%= options.enable_section_numbering ? "section-numbering" : "" %>">

<div class="header">
  <a class="toggle-toc" href="#">
  <div class="row">
    <div class='twelve columns'>
      
      
      <div class="title">Table of Contents <i class="fa fa-caret-down"></i> <i class="fa fa-caret-up"></i></div>  
      <i class="fa fa-align-left"></i> <span class="section">Contents</span>
    </div>
  </div>
  </a>
</div>

<!-- Table of Contents -->
<% 
  var sections = [];
  
  var nodes = doc.get('content').nodes;
  var currentSection;
  _.each(nodes, function(nodeId) {
    var node = doc.get(nodeId);

    if (node.type === "heading") {
      currentSection = {
        "heading": node,
        figures: []
      };
      sections.push(currentSection);
    } else if (currentSection) {

      // Add teaser to section if it does not yet exist
      if (node.type === "text" && !currentSection.teaser) {
        currentSection.teaser = node;
      }

      // Collect figures per section
      if (node.type === "figure") {
        currentSection.figures.push(node);
      }
    }
  });
%> 


<div class="toc">
  <div class="toc-entries">
    <% _.each(sections, function(section) { %>

      <div class="toc-entry level-<%= section.heading.level %>">
        <div class="row">
          <div class="eight columns">
            <a href="#<%= section.heading.id %>" class="jumpto-node" data-id="<%= section.heading.id %>">
              <div class="heading"><%= section.heading.content %></div>
              <div class="teaser">
                <% if (section.teaser) { %>
                  <%= section.teaser.content %>
                <% } %>
              </div>
            </a>
          </div>
          <!-- <div class="one columns"></div> -->
          <div class="four columns figures">
            <% _.each(section.figures, function(figure) { %>
              <a class="figure jumpto-node" data-id="<%= figure.id %>" href="#<%= figure.id %>">
                <img src="<%= figure.image %>">
              </a>
            <% }); %>
          </div>
        </div>
      </div>
    <% }); %>

    <% if (options.include_references && citations.length > 0) { %>
      <div class="toc-entry level-1">
        <div class="row">
          <div class="eight columns">
            <div class="heading">
              <a href="#heading_references" class="jumpto-node" data-id="heading_references">References</a>
            </div>
            <div class="teaser">
              
            </div>
          </div>
          <!-- <div class="one columns"></div> -->
          <div class="four columns figures">
          </div>
        </div>
      </div>
    <% } %>
  </div>
</div>

<div class="article">

<%= render(doc) %>


<% if (options.include_references && citations.length > 0) { %>


  <div id="heading_references" class='content-node heading level-1 row'>
    <div class='nine columns content'>
      <a href="#heading_references" class="anchor">#</a>
      <h1 class="heading-name">References</h1>
    </div>
    <div class="three columns"></div>
  </div>


  <div id="references" class="content-node references row">
      <!-- <div class='three columns'></div> -->
      <div class='nine columns'>


      
        <div class="citations">
          
          <% citations.forEach(function(citation) { %>
            <div class="citation" id="<%= citation.id %>">
              <div class="citation-url"><a href="<%= citation.url %>"><%= citation.url %></a></div>
              <div class="citation-description"><%= citation.description %></div>
            </div>
          <% }); %>
        </div>
      
      </div>
      <div class='three columns'></div>
  </div>
<% } %>

<!-- Publication Info - Footer -->

<div id="publication_info" class="content-node publication-info">
  <div class="row">
  
    <!-- <div class='three columns'></div> -->
    <div class='nine columns'>

      <!-- Publish date -->
      <div class="published-on">
        “<%= doc.title %>” was published on <%= new Date(doc.published_on).toDateString() %>. It has been modified on <%= new Date(doc.updated_at).toDateString() %>.
      </div>

      <% var authors = []; %>
      <%
        doc.getAuthors().forEach(function(a) {
          if (a.description) authors.push(a);
        });
      %>
      <% if (authors.length > 0) { %>
        <div class="authors">
          <% authors.forEach(function(a) { %>
            <div class="author" id="<%= a.id %>">
              <img class="author-image" src="<%= a.image %>"/>
              <div class="author-name"><%= a.name %></div>
              <div class="author-description"><%= a.description %></div>
            </div>
          <% }); %>
        </div>
      <% } %>

      <% if (options.include_source_file) { %>
        <!-- Source file download if exists -->
        <div class="supplements">
          <div class="label">Supplements</div>
          <div class="file">
            <div class="file-name"><a href="<%= filename %>"><%= filename %></a></div>
            <div class="file-description">
              Download this article to read offline, add personal notes and even edit.<br/>Just make sure to install the <a href="http://substance.io/composer">Substance Composer</a> on your desktop.
            </div>
          </div>
        </div>
      <% } %>


    </div>
    <div class="three columns legal">



      <!-- Copyright Statement -->
      <div class="copyright">
        <% var license = doc.get('license'); %>

        <% if (authors.length > 0) { %>
        <div class="copyright-statement">
          Copyright &copy; <%= new Date(doc.published_on).getFullYear() %>
          <%= authors.map(function(a) { return a.name; }).join(', ') %>
        </div>
        <% } %>
        
        <div class="license">
          <%= license.description %>
          <% if (license.url) { %>
          See <a href="<%= license.url %>"><%= license.name %></a>.
          <% } %>
        </div>

        <!-- Credits -->
        <div class="credits">
          This article was created with <a href="http://substance.io/composer">Substance</a>, an open self-publishing system.
        </div>

      </div>

    </div>
  </div>
</div>

</div>

</body>
</html>
